# AI 财务与投手管理系统 - 开发计划 v2.1

## 1. 项目概览

- **项目名称**：AI 财务与投手管理系统  
- **开发模式**：单人主导 + Claude Code 协助（无需 bolt.new/Cursor）  
- **目标**：补齐渠道、异常检测、智能对账、权限体系、前端 UI，并完成测试与部署  
- **技术栈**：FastAPI + SQLAlchemy + Pydantic、Next.js 14 + TypeScript + Tailwind CSS、Supabase PostgreSQL（RLS）  
- **期望周期**：9-13 天（按阶段执行）

---

## 2. 开发顺序（关键要点）

1. **数据库**：渠道相关表、月度渠道绩效、日报 channel_id  
2. **后端认证/权限**：Supabase Auth 对接、JWT 解析、角色限制、RLS 策略  
3. **核心业务 API**：渠道管理、日报异常检测、自动对账  
4. **前端页面**：投手上报、财务录入、渠道管理、对账  
5. **测试与错误处理**：统一异常处理、前端 Toast、接口单测、CI  
6. **部署与运维**：PM2、Nginx、定时任务、日志管理

每一步都附带可以直接给 Claude Code 的 Prompt，确保效率和一致性。

---

## 3. 阶段规划与执行脚本

### 阶段 1：数据库扩展 & 环境校验（Day 1）

**目标**：补全渠道相关数据结构，确保 Supabase 环境可用。  
**任务**：
- 新建 `channels`、`project_channels`、`monthly_channel_performance` 表  
- 在 `ad_spend_daily` 表添加 `channel_id` 字段  
- 索引、外键、默认值补齐  
- 校验 Supabase 连接与环境变量

**Prompt 示例**：
```
请为 Supabase/PostgreSQL 编写以下 SQL：
1. 创建 channels 表，字段 id, name, contact, rebate_rate, status(active/disabled), note, created_at。
2. 创建 project_channels（project_id 与 channel_id 的多对多关系）。
3. 修改 ad_spend_daily 表，新增可为空的 channel_id 字段。
4. 创建 monthly_channel_performance 表，包含渠道月统计。
要求：使用 SERIAL/REFERENCES，补齐索引与约束。
```

```
请根据上述结构生成 Alembic 迁移脚本，包含 upgrade/downgrade 方法。
```

```
请写一个 Python 脚本，使用 SQLAlchemy 检查数据库连接和上述表是否存在，缺失时打印表名。
```

### 阶段 2：认证与权限打底（Day 2）

**目标**：建立身份认证、角色体系、RLS。  
**任务**：
- 后端：实现 JWT 解析、用户信息依赖、角色校验依赖  
- 前端：Supabase Auth client、`useAuth` hook、页面级别路由保护示例  
- 数据库：为 `ad_spend_daily`、`channels` 等表编写 RLS 策略

**Prompt 示例**：
```
请写 FastAPI 认证模块：解析 Supabase JWT，提供 get_current_user() 和 require_role(...) 依赖，将代码放在 backend/app/dependencies/auth.py。
```

```
请为 Next.js 14 + App Router 编写 Supabase Auth 集成：
- lib/supabase/client.ts
- useAuth hook
- /finance/ledger 页面访问控制示例（仅 finance/admin）。
```

```
请撰写 Supabase RLS 策略示例：
- ad_spend_daily：仅本人可读写；
- channels：account_mgr/admin 可全量访问，其余角色仅能看公开渠道。
```

### 阶段 3：核心后端 API（Day 3-5）

**目标**：实现渠道管理、日报异常检测、自动对账。  
**任务模块**：

#### 3.1 渠道管理 API
- `GET/POST/PUT/DELETE /api/channels`
- `GET /api/channels/stats`
- 项目关联接口：`POST /api/channels/projects/{project_id}/channels`
- 权限：仅 account_mgr/admin 有写权限

**Prompt**：
```
生成 FastAPI 路由 channels.py：包含 CRUD、状态筛选、权限校验、项目关联和统计接口，使用 SQLAlchemy，返回格式 {data, error, meta, warning}。
```

#### 3.2 日报异常检测
- 在 `POST /api/ad-spend` 中加入 30% 波动提示  
- 比对同 operator + project + platform 的上一条记录  
- warning 提示不影响保存

**Prompt**：
```
请增强 ad-spend 接口：新增异常检测 service，若与上一条记录金额差异 >30%，返回 warning 字段，同时保留记录。提供完整 router + service 示例。
```

#### 3.3 智能对账算法
- 匹配条件：金额差 ≤ 5%，日期差 ≤ 1 天  
- 结果写入 `reconciliation` 表，自动生成统计  
- 提供 `POST /api/reconcile/run` 接口

**Prompt**：
```
请编写自动对账 service：比较 ad_spend_daily 与 ledger_transactions 最近 7 天记录，满足金额与日期阈值则标记 matched，否则 need_review。给出 service 代码和 FastAPI 路由。
```

### 阶段 4：前端页面完善（Day 5-7）

**目标**：把后端能力转化为可用 UI。  
**需要完成的页面**：
1. `/report/spend`：增加渠道选择、warning 提示、历史筛选  
2. `/finance/ledger`：录入表单、批量导入提示、分类展示  
3. `/settings/channels`：渠道列表、增删改、绩效数据  
4. `/reconcile`：执行对账按钮、表格展示、状态筛选

**Prompt 示例**：
```
生成 Next.js 14 页面 /report/spend：
- 左侧表单（日期、项目、渠道、投手、金额、平台、备注），右侧历史列表；
- 渠道下拉来自 GET /api/channels；
- 接收 warning 显示黄色提示；
- 移动端上下布局，桌面端左右布局；
- 使用 Tailwind。
```

```
生成 /settings/channels 页面：渠道表格 + 新增/编辑/删除功能，只有 account_mgr/admin 可访问，使用 Tailwind。
```

```
生成 /reconcile 页面：执行对账按钮（调 POST /api/reconcile/run）、表格展示、状态颜色、筛选条件。
```

### 阶段 5：测试与错误处理（Day 7-8）

**目标**：增强异常处理、前端提示、接口单测、自动化。  
**任务**：
- 后端统一异常处理并记录日志  
- 前端全局 Toast 组件（成功/警告/错误）  
- FastAPI TestClient 单元测试覆盖关键接口  
- 配置简单 CI（pytest + npm test）

**Prompt 示例**：
```
请编写 FastAPI 全局异常处理模块，处理 ValidationError/HTTPException/通用异常，写入日志，并给出 main.py 注册方法。
```

```
请实现 React + Tailwind 的全局 Toast 组件，并提供表单提交时的调用示例。
```

```
编写 pytest 测试：POST/GET /api/channels、POST /api/reconcile/run，使用 TestClient 和模拟权限。
```

### 阶段 6：部署与运维（Day 8-9）

**目标**：上线运行稳定、日志可追踪、定时任务可执行。  
**任务**：
- PM2 管理前后端进程  
- Nginx 配置（反代 + HTTPS + gzip + 安全 header）  
- 定时调用对账与渠道统计脚本  
- 日志轮转与监控

**Prompt 示例**：
```
请编写 ecosystem.config.js，配置 Next.js 与 FastAPI 的 PM2 进程，包含日志路径。
```

```
提供 Python 脚本示例：每天 2 点调 /api/reconcile/run，每月 1 日 3 点调用渠道统计；同时说明 crontab 调度方式。
```

```
编写 Nginx 配置：/ → Next.js、/api/ → FastAPI，启用 HTTPS、gzip、安全 header，可直接用于宝塔。
```

---

## 4. 角色与业务规则速查

```
角色：
- operator：广告投手（仅能提交自己的日报）
- finance：财务（财务收支 + 对账权限）
- account_mgr：户管/渠道管理
- manager：管理层（只读）
- admin：系统管理员

规则：
- 渠道（channel）为必填字段
- 日报异常阈值：金额变动 > 30% → warning
- 自动对账匹配：金额差 ≤ 5%，日期差 ≤ 1 天
- 所有写操作需记录 created_by/updated_by
```

---

## 5. 交付与验收标准

1. API 按 `{ data, error, meta, warning }` 统一返回结构  
2. 前端所有页面具备加载/错误/成功/警告状态，禁用内联样式  
3. 权限控制、RLS 生效，不同角色访问受限  
4. 渠道、日报、对账功能完整，算法符合阈值要求  
5. 单元测试覆盖关键接口，CI 通过  
6. 宝塔部署成功，PM2/Nginx 运行正常，HTTPS 生效  
7. 定时任务按计划执行，可生成日志和统计  
8. 所有 Prompt & 代码变更记录完整，便于追溯

---

## 6. 建议执行节奏（示例）

| 天数 | 上午 | 下午 | 输出 |
|------|------|------|------|
| Day 1 | Supabase 建表 | env/RLS 校验 | 建表 SQL + 脚本 |
| Day 2 | JWT 解析模块 | 前端 Auth 集成 | 权限依赖 + useAuth |
| Day 3 | 渠道 API | 日报异常 service | channels 路由 + warning 逻辑 |
| Day 4 | 对账 service | API 联调 | reconcile 路由上线 |
| Day 5 | `/report/spend` 页面 | `/finance/ledger` 页面 | UI + API 接入 |
| Day 6 | `/settings/channels` | `/reconcile` 页面 | 管理面板完成 |
| Day 7 | 异常处理 + Toast | 单测 + CI | pytest 通过 |
| Day 8 | 部署脚本/PM2 | Nginx/HTTPS | 上线验收 |
| Day 9 | 定时任务 + 日志 | 回归测试 | 测试报告 |

---

## 7. 结语

该计划完全适配“个人开发 + Claude Code 辅助”的流程：每个阶段先定义目标，再给出可直接粘贴的 Prompt，最后由你整合测试。只要严格按阶段推进，就能在两周内交付稳定可用的系统。
