# é¡¹ç›®ç»“æ„æŠ¥å‘Š

## 1. å‰ç«¯ä¸åç«¯æ¥å£ä¸€è‡´æ€§æ£€æŸ¥

### âœ… å·²åŒ¹é…çš„æ¥å£

| å‰ç«¯è°ƒç”¨ | åç«¯è·¯ç”± | çŠ¶æ€ |
|---------|---------|------|
| `/api/ad-spend` (POST) | `/api/ad-spend` | âœ… åŒ¹é… |
| `/api/ledger` (POST) | `/api/ledger` | âœ… åŒ¹é… |
| `/api/reconcile` (GET) | `/api/reconcile` | âœ… åŒ¹é… |
| `/api/reports/monthly` (GET) | `/api/reports/monthly` | âœ… åŒ¹é… |
| `/api/analytics/dashboard` (GET) | `/api/analytics/dashboard` | âœ… åŒ¹é… |
| `/api/projects` (GET/POST) | `/api/projects` | âœ… åŒ¹é… |
| `/api/operators` (GET/POST) | `/api/operators` | âœ… åŒ¹é… |
| `/api/me` (GET) | `/api/me` | âœ… åŒ¹é… |
| `/api/admin/users` (GET) | `/api/admin/users` | âœ… åŒ¹é… |
| `/api/admin/roles` (GET) | `/api/admin/roles` | âœ… åŒ¹é… |
| `/api/admin/users/{user_id}/roles` (POST) | `/api/admin/users/{user_id}/roles` | âœ… åŒ¹é… |
| `/api/admin/users/{user_id}/roles/{role_id}` (DELETE) | `/api/admin/users/{user_id}/roles/{role_id}` | âœ… åŒ¹é… |
| `/api/admin/permissions` (GET) | `/api/admin/permissions` | âœ… å·²è¡¥å…… |
| `/api/admin/roles/{role_id}/permissions` (POST) | `/api/admin/roles/{role_id}/permissions` | âœ… å·²è¡¥å…… |

### âš ï¸ æ³¨æ„äº‹é¡¹

- åç«¯æ¥å£è¿”å›æ ¼å¼ç»Ÿä¸€ä¸º `{ "data": ..., "error": null }` æˆ– `{ "data": null, "error": "..." }`
- å‰ç«¯ `lib/api.ts` å·²ç»Ÿä¸€å¤„ç†å“åº”æ ¼å¼ï¼Œè¿”å› `{ data, error }`
- æ‰€æœ‰æ¥å£å·²é€šè¿‡ä¸€è‡´æ€§æ£€æŸ¥

## 2. ç±»å‹å®šä¹‰æ–‡ä»¶

### âœ… å·²åˆ›å»ºçš„ç±»å‹æ–‡ä»¶

- `types/auth.ts` - ç”¨æˆ·è®¤è¯ç›¸å…³ç±»å‹
- `types/admin.ts` - ç®¡ç†å‘˜ç›¸å…³ç±»å‹
- `types/ad-spend.ts` - æŠ•æ‰‹æ¶ˆè€—ä¸ŠæŠ¥ç±»å‹
- `types/ledger.ts` - è´¢åŠ¡æ”¶æ”¯ç±»å‹
- `types/reconcile.ts` - å¯¹è´¦ç›¸å…³ç±»å‹

### ğŸ“ ç±»å‹ä½¿ç”¨æƒ…å†µ

- `ReconciliationTable` å·²ä½¿ç”¨ `ReconcileRecord` ç±»å‹
- å…¶ä»–ç»„ä»¶å»ºè®®é€æ­¥è¿ç§»åˆ°ç»Ÿä¸€ç±»å‹å®šä¹‰

## 3. lib/api.ts è§„èŒƒæ£€æŸ¥

### âœ… ç¬¦åˆè§„èŒƒ

- âœ… ä½¿ç”¨ `fetch` å®ç°
- âœ… åŸºç¡€ URL ä» `NEXT_PUBLIC_API_BASE_URL` è¯»å–
- âœ… å‡½æ•°åä¸º `apiRequest(path, options?)`
- âœ… è¿”å› `{ data, error }` ç»“æ„
- âœ… é»˜è®¤ `Content-Type` ä¸º `application/json`
- âœ… é”™è¯¯å¤„ç†å®Œå–„ï¼Œæ”¯æŒå¤šç§é”™è¯¯æ ¼å¼è§£æ

## 4. settings/roles/page.tsx æƒé™ç¼–è¾‘äº¤äº’

### âœ… å·²å®Œæˆ

- âœ… é¡µé¢åŠ è½½æ—¶ä» `/api/admin/roles` è·å–è§’è‰²åˆ—è¡¨
- âœ… æ¯ä¸ªè§’è‰²è¡Œæä¾›"ç¼–è¾‘æƒé™"æŒ‰é’®
- âœ… ç‚¹å‡»åå¼¹å‡º `RolePermissionDialog` å¯¹è¯æ¡†
- âœ… å¯¹è¯æ¡†ä» `/api/admin/permissions` è·å–å…¨éƒ¨æƒé™
- âœ… æ”¯æŒå‹¾é€‰åè°ƒç”¨ `POST /api/admin/roles/{role_id}/permissions` æ‰¹é‡æ›´æ–°
- âœ… æ›´æ–°ååˆ·æ–°æœ¬åœ°çŠ¶æ€

## 5. é¡¹ç›®ç»“æ„æ ‘

```
with-supabase-app/
â”œâ”€â”€ app/                                    âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ (auth)/                            âœ… å·²å®Œæˆ
â”‚   â”‚   â””â”€â”€ login/
â”‚   â”‚       â””â”€â”€ page.tsx                   âœ… ç™»å½•é¡µé¢
â”‚   â”œâ”€â”€ (protected)/                       âœ… å·²å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ layout.tsx                     âœ… ä¿æŠ¤å¸ƒå±€ï¼ˆç™»å½•æ£€æŸ¥+æƒé™æ‹¦æˆªï¼‰
â”‚   â”‚   â”œâ”€â”€ page.tsx                       âœ… ä»ªè¡¨ç›˜
â”‚   â”‚   â”œâ”€â”€ report/
â”‚   â”‚   â”‚   â””â”€â”€ spend/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx               âœ… æŠ•æ‰‹æ¶ˆè€—ä¸ŠæŠ¥
â”‚   â”‚   â”œâ”€â”€ finance/
â”‚   â”‚   â”‚   â””â”€â”€ ledger/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx               âœ… è´¢åŠ¡æ”¶æ”¯å½•å…¥
â”‚   â”‚   â”œâ”€â”€ reconcile/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                   âœ… å¯¹è´¦ç»“æœæŸ¥çœ‹
â”‚   â”‚   â”œâ”€â”€ analytics/
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx                   âœ… åˆ†ææŠ¥è¡¨
â”‚   â”‚   â””â”€â”€ settings/                      âœ… å·²å®Œæˆ
â”‚   â”‚       â”œâ”€â”€ page.tsx                   âœ… è®¾ç½®é¦–é¡µ
â”‚   â”‚       â”œâ”€â”€ projects/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx               âœ… é¡¹ç›®ç»´æŠ¤
â”‚   â”‚       â”œâ”€â”€ operators/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx               âœ… æŠ•æ‰‹ç»´æŠ¤
â”‚   â”‚       â”œâ”€â”€ channels/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx               âš ï¸ å¾…å®Œå–„ï¼ˆä»…å ä½ï¼‰
â”‚   â”‚       â”œâ”€â”€ users/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx               âœ… ç”¨æˆ·è§’è‰²åˆ†é…
â”‚   â”‚       â””â”€â”€ roles/
â”‚   â”‚           â””â”€â”€ page.tsx               âœ… è§’è‰²/æƒé™ç®¡ç†
â”‚   â”œâ”€â”€ layout.tsx                         âœ… å…¨å±€å¸ƒå±€ï¼ˆæŒ‚AppShellï¼‰
â”‚   â””â”€â”€ [å…¶ä»–æ¨¡æ¿æ–‡ä»¶]                      âœ… æ¨¡æ¿ä¿ç•™
â”‚
â”œâ”€â”€ components/                            âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ layout/                            âœ… å·²å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ AppShell.tsx                   âœ… ä¸»å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ AppSidebar.tsx                 âœ… å·¦ä¾§å¯¼èˆªï¼ˆæ”¯æŒè§’è‰²æ§åˆ¶ï¼‰
â”‚   â”‚   â”œâ”€â”€ AppHeader.tsx                  âœ… é¡¶éƒ¨æ 
â”‚   â”‚   â””â”€â”€ RoleGuard.tsx                  âœ… è§’è‰²å®ˆå«ç»„ä»¶
â”‚   â”œâ”€â”€ features/                          âœ… å·²å®Œæˆ
â”‚   â”‚   â”œâ”€â”€ report/
â”‚   â”‚   â”‚   â””â”€â”€ SpendReportForm.tsx       âœ… æŠ•æ‰‹ä¸ŠæŠ¥è¡¨å•
â”‚   â”‚   â”œâ”€â”€ finance/
â”‚   â”‚   â”‚   â””â”€â”€ FinanceLedgerForm.tsx     âœ… è´¢åŠ¡è¡¨å•
â”‚   â”‚   â”œâ”€â”€ reconciliation/
â”‚   â”‚   â”‚   â””â”€â”€ ReconciliationTable.tsx   âœ… å¯¹è´¦è¡¨æ ¼
â”‚   â”‚   â”œâ”€â”€ analytics/
â”‚   â”‚   â”‚   â””â”€â”€ AnalyticsCharts.tsx       âœ… åˆ†æå›¾è¡¨
â”‚   â”‚   â””â”€â”€ settings/                      âœ… å·²å®Œæˆ
â”‚   â”‚       â”œâ”€â”€ ProjectTable.tsx          âœ… é¡¹ç›®è¡¨æ ¼
â”‚   â”‚       â”œâ”€â”€ OperatorTable.tsx         âœ… æŠ•æ‰‹è¡¨æ ¼
â”‚   â”‚       â”œâ”€â”€ UserRoleDialog.tsx        âœ… ç”¨æˆ·è§’è‰²åˆ†é…å¯¹è¯æ¡†
â”‚   â”‚       â”œâ”€â”€ RolePermissionDialog.tsx  âœ… è§’è‰²æƒé™ç¼–è¾‘å¯¹è¯æ¡†
â”‚   â”‚       â””â”€â”€ RoleTable.tsx             âœ… è§’è‰²è¡¨æ ¼
â”‚   â”œâ”€â”€ ui/                                âœ… shadcn/ui ç»„ä»¶
â”‚   â””â”€â”€ [å…¶ä»–æ¨¡æ¿ç»„ä»¶]                      âœ… æ¨¡æ¿ä¿ç•™
â”‚
â”œâ”€â”€ hooks/                                 âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ useApi.ts                          âœ… API è¯·æ±‚ Hook
â”‚   â””â”€â”€ useCurrentUser.ts                 âœ… å½“å‰ç”¨æˆ·ä¿¡æ¯ Hook
â”‚
â”œâ”€â”€ lib/                                   âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ api.ts                             âœ… ç»Ÿä¸€ API è¯·æ±‚å‡½æ•°
â”‚   â”œâ”€â”€ api/                               âš ï¸ éƒ¨åˆ†æ–‡ä»¶ï¼ˆå¯æ¸…ç†ï¼‰
â”‚   â”‚   â”œâ”€â”€ ad-spend.ts
â”‚   â”‚   â”œâ”€â”€ channels.ts
â”‚   â”‚   â”œâ”€â”€ operators.ts
â”‚   â”‚   â””â”€â”€ projects.ts
â”‚   â””â”€â”€ supabase/                          âœ… Supabase å®¢æˆ·ç«¯
â”‚
â”œâ”€â”€ types/                                 âœ… å·²å®Œæˆ
â”‚   â”œâ”€â”€ auth.ts                            âœ… è®¤è¯ç±»å‹
â”‚   â”œâ”€â”€ admin.ts                           âœ… ç®¡ç†å‘˜ç±»å‹
â”‚   â”œâ”€â”€ ad-spend.ts                        âœ… æŠ•æ‰‹æ¶ˆè€—ç±»å‹
â”‚   â”œâ”€â”€ ledger.ts                          âœ… è´¢åŠ¡æ”¶æ”¯ç±»å‹
â”‚   â””â”€â”€ reconcile.ts                       âœ… å¯¹è´¦ç±»å‹
â”‚
â””â”€â”€ [é…ç½®æ–‡ä»¶]                             âœ… å·²å®Œæˆ
    â”œâ”€â”€ package.json
    â”œâ”€â”€ tsconfig.json
    â”œâ”€â”€ tailwind.config.ts
    â””â”€â”€ next.config.ts
```

## 6. å¾…è¡¥å…¨æ¨¡å—

### âš ï¸ éœ€è¦å®Œå–„çš„åŠŸèƒ½

1. **æ¸ é“ç®¡ç†é¡µé¢** (`app/(protected)/settings/channels/page.tsx`)
   - å½“å‰ä»…å ä½
   - éœ€è¦å®ç°æ¸ é“åˆ—è¡¨ã€æ–°å¢ã€ç¼–è¾‘ã€åˆ é™¤åŠŸèƒ½
   - éœ€è¦è°ƒç”¨ `/api/channels` ç›¸å…³æ¥å£

2. **ç±»å‹å¼•ç”¨ä¼˜åŒ–**
   - éƒ¨åˆ†ç»„ä»¶ä»ä½¿ç”¨æœ¬åœ°æ¥å£å®šä¹‰
   - å»ºè®®é€æ­¥è¿ç§»åˆ° `types/` ç›®å½•çš„ç»Ÿä¸€ç±»å‹

3. **åç«¯æ¥å£å®Œå–„**
   - `/api/admin/permissions` - âœ… å·²è¡¥å……
   - `/api/admin/roles/{role_id}/permissions` - âœ… å·²è¡¥å……
   - å…¶ä»–æ¥å£è¿”å›æ ¼å¼éœ€ç»Ÿä¸€ä¸º `{ data, error }` ç»“æ„

4. **é”™è¯¯å¤„ç†å¢å¼º**
   - å‰ç«¯é”™è¯¯æç¤ºå¯æ›´å‹å¥½
   - åç«¯é”™è¯¯ä¿¡æ¯å¯æ›´è¯¦ç»†

## 7. æ€»ç»“

### âœ… å·²å®Œæˆé¡¹

- âœ… å‰ç«¯é¡µé¢ç»“æ„å®Œæ•´
- âœ… ä¸šåŠ¡ç»„ä»¶é½å…¨
- âœ… API è¯·æ±‚å°è£…è§„èŒƒ
- âœ… ç±»å‹å®šä¹‰å®Œæ•´
- âœ… æƒé™ç®¡ç†åŠŸèƒ½å®Œæ•´
- âœ… è§’è‰²æƒé™ç¼–è¾‘äº¤äº’å®Œæ•´

### ğŸ“‹ å¾…ä¼˜åŒ–é¡¹

- âš ï¸ æ¸ é“ç®¡ç†é¡µé¢å¾…å®ç°
- âš ï¸ éƒ¨åˆ†ç»„ä»¶ç±»å‹å¼•ç”¨å¾…ç»Ÿä¸€
- âš ï¸ é”™è¯¯å¤„ç†å¯è¿›ä¸€æ­¥ä¼˜åŒ–

---

**ç”Ÿæˆæ—¶é—´**: 2024-11-04
**é¡¹ç›®ç‰ˆæœ¬**: v2.1

